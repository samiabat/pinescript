//@version=5
indicator("ICT Trading Signals", overlay=true, max_boxes_count=500, max_lines_count=500, max_labels_count=500)

// ═══════════════════════════════════════════════════════════════════════════
// INPUT PARAMETERS
// ═══════════════════════════════════════════════════════════════════════════

// Order Blocks Settings
showOrderBlocks = input.bool(true, "Show Order Blocks", group="Order Blocks")
obLookback = input.int(10, "Order Block Lookback", minval=5, maxval=50, group="Order Blocks")
obColor_bull = input.color(color.new(color.green, 85), "Bullish OB Color", group="Order Blocks")
obColor_bear = input.color(color.new(color.red, 85), "Bearish OB Color", group="Order Blocks")

// Fair Value Gap Settings
showFVG = input.bool(true, "Show Fair Value Gaps", group="Fair Value Gaps")
fvgColor_bull = input.color(color.new(color.blue, 80), "Bullish FVG Color", group="Fair Value Gaps")
fvgColor_bear = input.color(color.new(color.orange, 80), "Bearish FVG Color", group="Fair Value Gaps")

// Market Structure Settings
showMS = input.bool(true, "Show Market Structure", group="Market Structure")
msLookback = input.int(5, "Structure Lookback", minval=3, maxval=20, group="Market Structure")

// Liquidity Settings
showLiquidity = input.bool(true, "Show Liquidity Levels", group="Liquidity")
liqLookback = input.int(20, "Liquidity Lookback", minval=10, maxval=100, group="Liquidity")
liqColor = input.color(color.new(color.purple, 50), "Liquidity Color", group="Liquidity")

// OTE (Optimal Trade Entry) Settings
showOTE = input.bool(true, "Show OTE Zones", group="OTE Settings")
oteColor = input.color(color.new(color.yellow, 90), "OTE Zone Color", group="OTE Settings")

// Signal Settings
showSignals = input.bool(true, "Show Buy/Sell Signals", group="Signals")
signalConfluence = input.int(2, "Min Confluence Required", minval=1, maxval=4, group="Signals")

// ═══════════════════════════════════════════════════════════════════════════
// HELPER FUNCTIONS
// ═══════════════════════════════════════════════════════════════════════════

// Swing High/Low Detection
isSwingHigh(len) =>
    highestHigh = high == ta.highest(high, len * 2 + 1)
    centeredHigh = true
    for i = 1 to len
        if high <= high[i] or high <= high[-i]
            centeredHigh := false
            break
    highestHigh and centeredHigh

isSwingLow(len) =>
    lowestLow = low == ta.lowest(low, len * 2 + 1)
    centeredLow = true
    for i = 1 to len
        if low >= low[i] or low >= low[-i]
            centeredLow := false
            break
    lowestLow and centeredLow

// ═══════════════════════════════════════════════════════════════════════════
// ORDER BLOCKS DETECTION
// ═══════════════════════════════════════════════════════════════════════════

var box[] bullishOBs = array.new_box()
var box[] bearishOBs = array.new_box()

// Detect Bullish Order Block (last down candle before strong up move)
detectBullishOB() =>
    result = false
    obTop = 0.0
    obBottom = 0.0
    obLeft = 0
    
    // Look for strong bullish move
    if close > close[1] and (close - open) > (high[1] - low[1]) * 0.5
        // Find the last bearish candle before the move
        for i = 1 to obLookback
            if close[i] < open[i]  // Bearish candle
                obTop := high[i]
                obBottom := low[i]
                obLeft := bar_index - i
                result := true
                break
    [result, obLeft, obTop, obBottom]

// Detect Bearish Order Block (last up candle before strong down move)
detectBearishOB() =>
    result = false
    obTop = 0.0
    obBottom = 0.0
    obLeft = 0
    
    // Look for strong bearish move
    if close < close[1] and (open - close) > (high[1] - low[1]) * 0.5
        // Find the last bullish candle before the move
        for i = 1 to obLookback
            if close[i] > open[i]  // Bullish candle
                obTop := high[i]
                obBottom := low[i]
                obLeft := bar_index - i
                result := true
                break
    [result, obLeft, obTop, obBottom]

// Draw Order Blocks
if showOrderBlocks
    [isBullOB, bullLeft, bullTop, bullBottom] = detectBullishOB()
    if isBullOB
        ob = box.new(bullLeft, bullTop, bar_index + 20, bullBottom, 
                     border_color=color.new(color.green, 50), 
                     bgcolor=obColor_bull,
                     border_width=1,
                     extend=extend.right)
        array.push(bullishOBs, ob)
        
        // Limit array size
        if array.size(bullishOBs) > 10
            box.delete(array.shift(bullishOBs))
    
    [isBearOB, bearLeft, bearTop, bearBottom] = detectBearishOB()
    if isBearOB
        ob = box.new(bearLeft, bearTop, bar_index + 20, bearBottom, 
                     border_color=color.new(color.red, 50), 
                     bgcolor=obColor_bear,
                     border_width=1,
                     extend=extend.right)
        array.push(bearishOBs, ob)
        
        // Limit array size
        if array.size(bearishOBs) > 10
            box.delete(array.shift(bearishOBs))

// ═══════════════════════════════════════════════════════════════════════════
// FAIR VALUE GAPS (FVG) DETECTION
// ═══════════════════════════════════════════════════════════════════════════

var box[] bullishFVGs = array.new_box()
var box[] bearishFVGs = array.new_box()

// Bullish FVG: Gap between high[2] and low[0]
bullishFVG = low > high[2]
if showFVG and bullishFVG
    fvgBox = box.new(bar_index - 2, low, bar_index + 10, high[2],
                     border_color=color.new(color.blue, 70),
                     bgcolor=fvgColor_bull,
                     border_width=1,
                     extend=extend.right)
    array.push(bullishFVGs, fvgBox)
    
    if array.size(bullishFVGs) > 5
        box.delete(array.shift(bullishFVGs))

// Bearish FVG: Gap between low[2] and high[0]
bearishFVG = high < low[2]
if showFVG and bearishFVG
    fvgBox = box.new(bar_index - 2, low[2], bar_index + 10, high,
                     border_color=color.new(color.orange, 70),
                     bgcolor=fvgColor_bear,
                     border_width=1,
                     extend=extend.right)
    array.push(bearishFVGs, fvgBox)
    
    if array.size(bearishFVGs) > 5
        box.delete(array.shift(bearishFVGs))

// ═══════════════════════════════════════════════════════════════════════════
// MARKET STRUCTURE (Break of Structure - BOS)
// ═══════════════════════════════════════════════════════════════════════════

var float lastSwingHigh = na
var float lastSwingLow = na
var int lastSwingHighBar = na
var int lastSwingLowBar = na
var bool bosUp = false
var bool bosDown = false

// Update swing points
if isSwingHigh(msLookback)
    lastSwingHigh := high
    lastSwingHighBar := bar_index

if isSwingLow(msLookback)
    lastSwingLow := low
    lastSwingLowBar := bar_index

// Detect BOS (Break of Structure)
bosUp := not na(lastSwingHigh) and close > lastSwingHigh
bosDown := not na(lastSwingLow) and close < lastSwingLow

// Draw BOS markers
if showMS and bosUp
    label.new(bar_index, low, "BOS↑", 
              style=label.style_label_up, 
              color=color.new(color.green, 0), 
              textcolor=color.white, 
              size=size.small)

if showMS and bosDown
    label.new(bar_index, high, "BOS↓", 
              style=label.style_label_down, 
              color=color.new(color.red, 0), 
              textcolor=color.white, 
              size=size.small)

// ═══════════════════════════════════════════════════════════════════════════
// LIQUIDITY POOLS (Equal Highs/Lows)
// ═══════════════════════════════════════════════════════════════════════════

// Detect equal highs (liquidity above)
equalHighs = false
for i = 1 to liqLookback
    if math.abs(high - high[i]) < (high * 0.001) and high[i] == ta.highest(high, i + 5)
        equalHighs := true
        break

// Detect equal lows (liquidity below)
equalLows = false
for i = 1 to liqLookback
    if math.abs(low - low[i]) < (low * 0.001) and low[i] == ta.lowest(low, i + 5)
        equalLows := true
        break

// Draw liquidity markers
if showLiquidity and equalHighs
    line.new(bar_index - 5, high, bar_index + 5, high, 
             color=liqColor, 
             width=2, 
             style=line.style_dashed)
    label.new(bar_index, high, "LIQ", 
              style=label.style_label_down, 
              color=liqColor, 
              textcolor=color.white, 
              size=size.tiny)

if showLiquidity and equalLows
    line.new(bar_index - 5, low, bar_index + 5, low, 
             color=liqColor, 
             width=2, 
             style=line.style_dashed)
    label.new(bar_index, low, "LIQ", 
              style=label.style_label_up, 
              color=liqColor, 
              textcolor=color.white, 
              size=size.tiny)

// ═══════════════════════════════════════════════════════════════════════════
// OPTIMAL TRADE ENTRY (OTE) - Fibonacci 0.62-0.79 retracement zone
// ═══════════════════════════════════════════════════════════════════════════

var box[] oteBoxes = array.new_box()
var float swingStart = na
var float swingEnd = na
var int swingStartBar = na

// Detect significant swing for OTE
if isSwingLow(msLookback) and not na(lastSwingHigh)
    swingStart := lastSwingHigh
    swingEnd := low
    swingStartBar := lastSwingHighBar
    
    // Calculate OTE zone (62-79% retracement)
    range = swingStart - swingEnd
    oteHigh = swingEnd + (range * 0.79)
    oteLow = swingEnd + (range * 0.62)
    
    if showOTE
        oteBox = box.new(swingStartBar, oteHigh, bar_index + 15, oteLow,
                         border_color=color.new(color.yellow, 60),
                         bgcolor=oteColor,
                         border_width=1,
                         extend=extend.right)
        array.push(oteBoxes, oteBox)
        
        if array.size(oteBoxes) > 3
            box.delete(array.shift(oteBoxes))

if isSwingHigh(msLookback) and not na(lastSwingLow)
    swingStart := lastSwingLow
    swingEnd := high
    swingStartBar := lastSwingLowBar
    
    // Calculate OTE zone (62-79% retracement)
    range = swingEnd - swingStart
    oteHigh = swingEnd - (range * 0.62)
    oteLow = swingEnd - (range * 0.79)
    
    if showOTE
        oteBox = box.new(swingStartBar, oteHigh, bar_index + 15, oteLow,
                         border_color=color.new(color.yellow, 60),
                         bgcolor=oteColor,
                         border_width=1,
                         extend=extend.right)
        array.push(oteBoxes, oteBox)
        
        if array.size(oteBoxes) > 3
            box.delete(array.shift(oteBoxes))

// ═══════════════════════════════════════════════════════════════════════════
// SIGNAL GENERATION WITH CONFLUENCE
// ═══════════════════════════════════════════════════════════════════════════

// Check for price in OTE zone
inOTEZone = false
if array.size(oteBoxes) > 0
    for i = 0 to array.size(oteBoxes) - 1
        lastOTE = array.get(oteBoxes, i)
        oteTop = box.get_top(lastOTE)
        oteBottom = box.get_bottom(lastOTE)
        if close >= math.min(oteTop, oteBottom) and close <= math.max(oteTop, oteBottom)
            inOTEZone := true
            break

// Check for price near bullish order block
nearBullishOB = false
if array.size(bullishOBs) > 0
    for i = 0 to array.size(bullishOBs) - 1
        ob = array.get(bullishOBs, i)
        obTop = box.get_top(ob)
        obBottom = box.get_bottom(ob)
        if close <= obTop and close >= obBottom
            nearBullishOB := true
            break

// Check for price near bearish order block
nearBearishOB = false
if array.size(bearishOBs) > 0
    for i = 0 to array.size(bearishOBs) - 1
        ob = array.get(bearishOBs, i)
        obTop = box.get_top(ob)
        obBottom = box.get_bottom(ob)
        if close <= obTop and close >= obBottom
            nearBearishOB := true
            break

// Check for price in bullish FVG
inBullishFVG = false
if array.size(bullishFVGs) > 0
    for i = 0 to array.size(bullishFVGs) - 1
        fvg = array.get(bullishFVGs, i)
        fvgTop = box.get_top(fvg)
        fvgBottom = box.get_bottom(fvg)
        if close <= fvgTop and close >= fvgBottom
            inBullishFVG := true
            break

// Check for price in bearish FVG
inBearishFVG = false
if array.size(bearishFVGs) > 0
    for i = 0 to array.size(bearishFVGs) - 1
        fvg = array.get(bearishFVGs, i)
        fvgTop = box.get_top(fvg)
        fvgBottom = box.get_bottom(fvg)
        if close <= fvgTop and close >= fvgBottom
            inBearishFVG := true
            break

// Calculate confluence for bullish signal
bullishConfluence = 0
if bosUp
    bullishConfluence := bullishConfluence + 1
if nearBullishOB
    bullishConfluence := bullishConfluence + 1
if inBullishFVG
    bullishConfluence := bullishConfluence + 1
if inOTEZone and close > open
    bullishConfluence := bullishConfluence + 1

// Calculate confluence for bearish signal
bearishConfluence = 0
if bosDown
    bearishConfluence := bearishConfluence + 1
if nearBearishOB
    bearishConfluence := bearishConfluence + 1
if inBearishFVG
    bearishConfluence := bearishConfluence + 1
if inOTEZone and close < open
    bearishConfluence := bearishConfluence + 1

// Generate signals based on confluence
buySignal = showSignals and bullishConfluence >= signalConfluence and close > open
sellSignal = showSignals and bearishConfluence >= signalConfluence and close < open

// Plot signals
plotshape(buySignal, title="Buy Signal", style=shape.labelup, location=location.belowbar, 
          color=color.new(color.green, 0), text="BUY", textcolor=color.white, size=size.normal)
plotshape(sellSignal, title="Sell Signal", style=shape.labeldown, location=location.abovebar, 
          color=color.new(color.red, 0), text="SELL", textcolor=color.white, size=size.normal)

// ═══════════════════════════════════════════════════════════════════════════
// ALERTS
// ═══════════════════════════════════════════════════════════════════════════

alertcondition(buySignal, title="ICT Buy Signal", message="ICT Buy Signal - Bullish confluence detected")
alertcondition(sellSignal, title="ICT Sell Signal", message="ICT Sell Signal - Bearish confluence detected")

// ═══════════════════════════════════════════════════════════════════════════
// INFO TABLE (Optional - displays current market conditions)
// ═══════════════════════════════════════════════════════════════════════════

var table infoTable = table.new(position.top_right, 2, 6, border_width=1)

if barstate.islast
    table.cell(infoTable, 0, 0, "ICT Indicator", bgcolor=color.new(color.gray, 70), text_color=color.white)
    table.cell(infoTable, 1, 0, "Status", bgcolor=color.new(color.gray, 70), text_color=color.white)
    
    table.cell(infoTable, 0, 1, "Market Structure", text_color=color.white)
    table.cell(infoTable, 1, 1, bosUp ? "Bullish BOS" : bosDown ? "Bearish BOS" : "Ranging", 
               text_color=bosUp ? color.green : bosDown ? color.red : color.yellow)
    
    table.cell(infoTable, 0, 2, "Order Block", text_color=color.white)
    table.cell(infoTable, 1, 2, nearBullishOB ? "In Bull OB" : nearBearishOB ? "In Bear OB" : "None", 
               text_color=nearBullishOB ? color.green : nearBearishOB ? color.red : color.gray)
    
    table.cell(infoTable, 0, 3, "FVG", text_color=color.white)
    table.cell(infoTable, 1, 3, inBullishFVG ? "Bull FVG" : inBearishFVG ? "Bear FVG" : "None", 
               text_color=inBullishFVG ? color.green : inBearishFVG ? color.red : color.gray)
    
    table.cell(infoTable, 0, 4, "OTE Zone", text_color=color.white)
    table.cell(infoTable, 1, 4, inOTEZone ? "Active" : "Inactive", 
               text_color=inOTEZone ? color.yellow : color.gray)
    
    table.cell(infoTable, 0, 5, "Signal", text_color=color.white)
    table.cell(infoTable, 1, 5, buySignal ? "BUY" : sellSignal ? "SELL" : "No Signal", 
               text_color=buySignal ? color.green : sellSignal ? color.red : color.gray,
               bgcolor=buySignal ? color.new(color.green, 80) : sellSignal ? color.new(color.red, 80) : color.new(color.gray, 90))
