//@version=5
indicator("ICT Concepts Indicator", overlay=true, max_boxes_count=50, max_lines_count=50)

// ============================================================================
// ICT CONCEPTS INDICATOR
// ============================================================================
// This indicator identifies and plots ICT (Inner Circle Trader) concepts:
// - Order Blocks (Bullish and Bearish)
// - Fair Value Gaps (FVG)
// - Market Structure Shifts
// - Buy/Sell signals with conflict prevention
// ============================================================================

// ==================== INPUT PARAMETERS ====================
// Order Block Settings
ob_length = input.int(10, "Order Block Lookback", minval=5, maxval=50, group="Order Blocks")
show_ob = input.bool(true, "Show Order Blocks", group="Order Blocks")

// Fair Value Gap Settings
fvg_threshold = input.float(0.0, "FVG Min Size (% of price)", minval=0.0, maxval=5.0, group="Fair Value Gaps")
show_fvg = input.bool(true, "Show Fair Value Gaps", group="Fair Value Gaps")

// Market Structure Settings
swing_length = input.int(5, "Swing Detection Length", minval=3, maxval=20, group="Market Structure")
show_structure = input.bool(true, "Show Market Structure", group="Market Structure")

// Signal Settings
signal_cooldown = input.int(5, "Signal Cooldown Periods", minval=1, maxval=20, group="Signals", tooltip="Minimum bars between signals")
show_signals = input.bool(true, "Show Buy/Sell Signals", group="Signals")

// ==================== COLORS ====================
bullish_ob_color = color.new(color.green, 85)
bearish_ob_color = color.new(color.red, 85)
bullish_fvg_color = color.new(color.blue, 90)
bearish_fvg_color = color.new(color.orange, 90)

// ==================== VARIABLES AND ARRAYS ====================
// Track zones to prevent overlaps
var array<float> bullish_ob_tops = array.new<float>()
var array<float> bullish_ob_bottoms = array.new<float>()
var array<int> bullish_ob_bars = array.new<int>()

var array<float> bearish_ob_tops = array.new<float>()
var array<float> bearish_ob_bottoms = array.new<float>()
var array<int> bearish_ob_bars = array.new<int>()

var array<float> fvg_tops = array.new<float>()
var array<float> fvg_bottoms = array.new<float>()
var array<int> fvg_bars = array.new<int>()

// Track last signal to prevent conflicts and enforce cooldown
var int last_signal_bar = -1000
var string last_signal_type = ""

// ==================== HELPER FUNCTIONS ====================

// Check if price range overlaps with existing zones
check_overlap(top, bottom, zone_tops, zone_bottoms) =>
    bool has_overlap = false
    if array.size(zone_tops) > 0
        for i = 0 to array.size(zone_tops) - 1
            existing_top = array.get(zone_tops, i)
            existing_bottom = array.get(zone_bottoms, i)
            // Check if ranges overlap
            if not (bottom > existing_top or top < existing_bottom)
                has_overlap := true
                break
    has_overlap

// Remove old zones (older than 100 bars)
cleanup_zones(zone_bars, zone_tops, zone_bottoms) =>
    if array.size(zone_bars) > 0
        for i = array.size(zone_bars) - 1 to 0
            if bar_index - array.get(zone_bars, i) > 100
                array.remove(zone_bars, i)
                array.remove(zone_tops, i)
                array.remove(zone_bottoms, i)

// ==================== ORDER BLOCK DETECTION ====================

// Detect Bullish Order Block (last down candle before strong up move)
detect_bullish_ob() =>
    bool is_ob = false
    float ob_top = na
    float ob_bottom = na
    
    if bar_index >= ob_length
        // Look for a down candle followed by bullish momentum
        if close[1] < open[1]  // Previous candle is bearish
            // Check if subsequent candles show bullish momentum
            bullish_momentum = close > close[1] and close > open
            
            if bullish_momentum
                // The bearish candle before the move is the order block
                ob_top := math.max(open[1], close[1])
                ob_bottom := math.min(open[1], close[1])
                
                // Check for overlap with existing bullish OBs
                if not check_overlap(ob_top, ob_bottom, bullish_ob_tops, bullish_ob_bottoms)
                    is_ob := true
    
    [is_ob, ob_top, ob_bottom]

// Detect Bearish Order Block (last up candle before strong down move)
detect_bearish_ob() =>
    bool is_ob = false
    float ob_top = na
    float ob_bottom = na
    
    if bar_index >= ob_length
        // Look for an up candle followed by bearish momentum
        if close[1] > open[1]  // Previous candle is bullish
            // Check if subsequent candles show bearish momentum
            bearish_momentum = close < close[1] and close < open
            
            if bearish_momentum
                // The bullish candle before the move is the order block
                ob_top := math.max(open[1], close[1])
                ob_bottom := math.min(open[1], close[1])
                
                // Check for overlap with existing bearish OBs
                if not check_overlap(ob_top, ob_bottom, bearish_ob_tops, bearish_ob_bottoms)
                    is_ob := true
    
    [is_ob, ob_top, ob_bottom]

// ==================== FAIR VALUE GAP DETECTION ====================

// Detect Bullish Fair Value Gap (gap up)
detect_bullish_fvg() =>
    bool is_fvg = false
    float fvg_top = na
    float fvg_bottom = na
    
    if bar_index >= 2
        // Bullish FVG: low[0] > high[2] (current low above previous high with gap)
        gap = low - high[2]
        gap_percent = (gap / close) * 100
        
        if gap > 0 and gap_percent >= fvg_threshold
            fvg_top := low
            fvg_bottom := high[2]
            
            // Check for overlap with existing FVGs
            if not check_overlap(fvg_top, fvg_bottom, fvg_tops, fvg_bottoms)
                is_fvg := true
    
    [is_fvg, fvg_top, fvg_bottom]

// Detect Bearish Fair Value Gap (gap down)
detect_bearish_fvg() =>
    bool is_fvg = false
    float fvg_top = na
    float fvg_bottom = na
    
    if bar_index >= 2
        // Bearish FVG: high[0] < low[2] (current high below previous low with gap)
        gap = low[2] - high
        gap_percent = (gap / close) * 100
        
        if gap > 0 and gap_percent >= fvg_threshold
            fvg_top := low[2]
            fvg_bottom := high
            
            // Check for overlap with existing FVGs
            if not check_overlap(fvg_top, fvg_bottom, fvg_tops, fvg_bottoms)
                is_fvg := true
    
    [is_fvg, fvg_top, fvg_bottom]

// ==================== MARKET STRUCTURE ====================

// Detect swing highs and lows
swing_high = ta.pivothigh(high, swing_length, swing_length)
swing_low = ta.pivotlow(low, swing_length, swing_length)

// Track market structure
var float last_swing_high = na
var float last_swing_low = na
var string market_structure = "neutral"  // "bullish", "bearish", "neutral"

if not na(swing_high)
    if not na(last_swing_high)
        // Break of Structure (BOS) - Higher High in uptrend
        if swing_high > last_swing_high and market_structure != "bullish"
            market_structure := "bullish"
    last_swing_high := swing_high

if not na(swing_low)
    if not na(last_swing_low)
        // Break of Structure (BOS) - Lower Low in downtrend
        if swing_low < last_swing_low and market_structure != "bearish"
            market_structure := "bearish"
    last_swing_low := swing_low

// ==================== SIGNAL GENERATION ====================

// Generate buy signal (bullish bias)
generate_buy_signal() =>
    bool signal = false
    
    // Conditions for buy signal:
    // 1. Bullish market structure
    // 2. Price near bullish order block or filled bearish FVG
    // 3. Cooldown period elapsed (minimum bars since last signal)
    // 4. No conflicting sell signal on same bar
    
    cooldown_ok = (bar_index - last_signal_bar) >= signal_cooldown
    // No conflict means: either last signal was also a buy (no conflict), or we're on a different bar
    no_conflict = last_signal_type != "sell" or (bar_index != last_signal_bar)
    
    if market_structure == "bullish" and cooldown_ok and no_conflict
        // Check if price is at a bullish order block
        near_bull_ob = false
        if array.size(bullish_ob_bottoms) > 0
            for i = 0 to array.size(bullish_ob_bottoms) - 1
                ob_top = array.get(bullish_ob_tops, i)
                ob_bottom = array.get(bullish_ob_bottoms, i)
                if low <= ob_top and low >= ob_bottom
                    near_bull_ob := true
                    break
        
        if near_bull_ob
            signal := true
    
    signal

// Generate sell signal (bearish bias)
generate_sell_signal() =>
    bool signal = false
    
    // Conditions for sell signal:
    // 1. Bearish market structure
    // 2. Price near bearish order block or filled bullish FVG
    // 3. Cooldown period elapsed (minimum bars since last signal)
    // 4. No conflicting buy signal on same bar
    
    cooldown_ok = (bar_index - last_signal_bar) >= signal_cooldown
    // No conflict means: either last signal was also a sell (no conflict), or we're on a different bar
    no_conflict = last_signal_type != "buy" or (bar_index != last_signal_bar)
    
    if market_structure == "bearish" and cooldown_ok and no_conflict
        // Check if price is at a bearish order block
        near_bear_ob = false
        if array.size(bearish_ob_bottoms) > 0
            for i = 0 to array.size(bearish_ob_bottoms) - 1
                ob_top = array.get(bearish_ob_tops, i)
                ob_bottom = array.get(bearish_ob_bottoms, i)
                if high >= ob_bottom and high <= ob_top
                    near_bear_ob := true
                    break
        
        if near_bear_ob
            signal := true
    
    signal

// ==================== MAIN LOGIC ====================

// Cleanup old zones
cleanup_zones(bullish_ob_bars, bullish_ob_tops, bullish_ob_bottoms)
cleanup_zones(bearish_ob_bars, bearish_ob_tops, bearish_ob_bottoms)
cleanup_zones(fvg_bars, fvg_tops, fvg_bottoms)

// Detect and plot Order Blocks
[is_bull_ob, bull_ob_top, bull_ob_bottom] = detect_bullish_ob()
[is_bear_ob, bear_ob_top, bear_ob_bottom] = detect_bearish_ob()

if is_bull_ob and show_ob
    array.push(bullish_ob_tops, bull_ob_top)
    array.push(bullish_ob_bottoms, bull_ob_bottom)
    array.push(bullish_ob_bars, bar_index)
    box.new(bar_index - 1, bull_ob_top, bar_index + 20, bull_ob_bottom, 
             border_color=color.green, bgcolor=bullish_ob_color, 
             text="Bull OB", text_color=color.green, text_size=size.tiny)

if is_bear_ob and show_ob
    array.push(bearish_ob_tops, bear_ob_top)
    array.push(bearish_ob_bottoms, bear_ob_bottom)
    array.push(bearish_ob_bars, bar_index)
    box.new(bar_index - 1, bear_ob_top, bar_index + 20, bear_ob_bottom, 
             border_color=color.red, bgcolor=bearish_ob_color, 
             text="Bear OB", text_color=color.red, text_size=size.tiny)

// Detect and plot Fair Value Gaps
[is_bull_fvg, bull_fvg_top, bull_fvg_bottom] = detect_bullish_fvg()
[is_bear_fvg, bear_fvg_top, bear_fvg_bottom] = detect_bearish_fvg()

if is_bull_fvg and show_fvg
    array.push(fvg_tops, bull_fvg_top)
    array.push(fvg_bottoms, bull_fvg_bottom)
    array.push(fvg_bars, bar_index)
    box.new(bar_index - 2, bull_fvg_top, bar_index + 15, bull_fvg_bottom, 
             border_color=color.blue, bgcolor=bullish_fvg_color, 
             text="FVG", text_color=color.blue, text_size=size.tiny)

if is_bear_fvg and show_fvg
    array.push(fvg_tops, bear_fvg_top)
    array.push(fvg_bottoms, bear_fvg_bottom)
    array.push(fvg_bars, bar_index)
    box.new(bar_index - 2, bear_fvg_top, bar_index + 15, bear_fvg_bottom, 
             border_color=color.orange, bgcolor=bearish_fvg_color, 
             text="FVG", text_color=color.orange, text_size=size.tiny)

// Generate signals
buy_signal = generate_buy_signal()
sell_signal = generate_sell_signal()

// Ensure no simultaneous signals (additional safety check)
if buy_signal and sell_signal
    // If both signals occur (shouldn't happen due to cooldown), prioritize based on market structure
    if market_structure == "bullish"
        sell_signal := false
    else
        buy_signal := false

// Update last signal tracking
if buy_signal
    last_signal_bar := bar_index
    last_signal_type := "buy"

if sell_signal
    last_signal_bar := bar_index
    last_signal_type := "sell"

// Plot signals
plotshape(show_signals and buy_signal, "Buy Signal", shape.labelup, location.belowbar, 
          color.new(color.green, 0), text="BUY", textcolor=color.white, size=size.small)
plotshape(show_signals and sell_signal, "Sell Signal", shape.labeldown, location.abovebar, 
          color.new(color.red, 0), text="SELL", textcolor=color.white, size=size.small)

// Plot market structure shifts
plotshape(show_structure and market_structure == "bullish" and market_structure[1] != "bullish", 
          "Bullish Structure", shape.triangleup, location.belowbar, 
          color.new(color.green, 50), size=size.tiny)
plotshape(show_structure and market_structure == "bearish" and market_structure[1] != "bearish", 
          "Bearish Structure", shape.triangledown, location.abovebar, 
          color.new(color.red, 50), size=size.tiny)

// ==================== ALERTS ====================
alertcondition(buy_signal, "Buy Signal", "ICT Buy Signal Generated")
alertcondition(sell_signal, "Sell Signal", "ICT Sell Signal Generated")
